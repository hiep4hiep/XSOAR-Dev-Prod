category: IT Services
commonfields:
  id: OMWS
  version: -1
configuration:
- defaultvalue: https://example.net
  display: Server URL (e.g. https://example.net)
  name: url
  required: true
  type: 0
- display: Username
  name: credentials
  required: true
  type: 9
- display: Trust any certificate (not secure)
  name: insecure
  required: false
  type: 8
- display: Use system proxy settings
  name: proxy
  required: false
  type: 8
- additionalinfo: The domain to use in NTLM Authentication
  display: NTLM Domain
  name: domain
  required: true
  type: 0
- additionalinfo: If set, automatically generates UUIDs for request transcations
  display: ""
  name: generate_transaction_uuids
  required: false
  type: 8
- additionalinfo: Change the OM code in all requests. Default sto OMCODE
  display: OM Code
  name: om_code
  required: false
  type: 0
contentitemexportablefields:
  contentitemfields:
    fromServerVersion: ""
    itemVersion: ""
    packID: ""
    propagationLabels:
    - all
    toServerVersion: ""
description: Custom integration
detaileddescription: |-
  ### Developer Contributed Integration
  #### Integration Author: Hiep
  Support and maintenance for this integration are provided by the author. Please use the following contact details:
  ***
  ## BaseIntegration Help

  Markdown file for integration configuration  help snippet. In this file add:
  - Brief information about how to retrieve the API key of your product
  - Other useful information on how to configure your integration in XSOAR

  Since this is a Markdown file, we encourage you to use MD formatting for sections, sub-sections, lists, etc.



  ---
  [View Integration Documentation](https://xsoar.pan.dev/docs/reference/integrations/omws)
display: OMWS (Developer Contribution)
image: data:image/png;base64,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
name: OMWS
script:
  commands:
  - arguments:
    - description: The user to query
      name: username
      required: true
    - description: The OM code if provided, overrides the default for this command.
      name: om_code
    description: Query the OMWS system for a given username.
    name: query-profile-data
    outputs:
    - contextPath: OMWS.GetEmpProfileByUserName.USERNAME
      description: Queried Username
      type: Unknown
    - contextPath: OMWS.GetEmpProfileByUserName.THFIRSTNAME
      description: First name of User
      type: Unknown
    - contextPath: OMWS.GetEmpProfileByUserName.THPREFIX
      description: Name Prefix
      type: Unknown
    - contextPath: OMWS.GetEmpProfileByUserName.EMAIL
      description: User Email Address
      type: Unknown
    - contextPath: OMWS.GetEmpProfileByUserName.COMPANYCODE
    - contextPath: OMWS.GetEmpProfileByUserName.EMPLOYEEGROUP
    - contextPath: OMWS.GetEmpProfileByUserName.POSITIONID
    - contextPath: OMWS.GetEmpProfileByUserName.EMPLOYEETYPE
    - contextPath: OMWS.GetEmpProfileByUserName.ENLASTNAME
    - contextPath: OMWS.GetEmpProfileByUserName.ORGNAME
    - contextPath: OMWS.GetEmpProfileByUserName.ORGCODE
    - contextPath: OMWS.GetEmpProfileByUserName.ENFIRSTNAME
    - contextPath: OMWS.GetEmpProfileByUserName.THLASTNAME
    - contextPath: OMWS.GetEmpProfileByUserName.PIN
    - contextPath: OMWS.GetEmpProfileByUserName.ORGDESC
    - contextPath: OMWS.GetEmpProfileByUserName.POSITIONDESC
  - arguments:
    - description: The employee id to query
      name: employee_id
      required: true
    - description: The OM code if provided, overrides the default for this command.
      name: om_code
    description: Query the OMWS system for detail information of a given employee
      id.
    name: query-profile-detail
    outputs:
    - contextPath: OMWS.GetEmpProfileByUserName.Detail.USERNAME
    - contextPath: OMWS.GetEmpProfileByUserName.COMPANYCODE
    - contextPath: OMWS.GetEmpProfileByUserName.EMPLOYEEGROUP
    - contextPath: OMWS.GetEmpProfileByUserName.POSITIONID
    - contextPath: OMWS.GetEmpProfileByUserName.EMPLOYEETYPE
    - contextPath: OMWS.GetEmpProfileByUserName.ENLASTNAME
    - contextPath: OMWS.GetEmpProfileByUserName.ORGNAME
    - contextPath: OMWS.GetEmpProfileByUserName.ORGCODE
    - contextPath: OMWS.GetEmpProfileByUserName.ENFIRSTNAME
    - contextPath: OMWS.GetEmpProfileByUserName.THLASTNAME
    - contextPath: OMWS.GetEmpProfileByUserName.PIN
    - contextPath: OMWS.GetEmpProfileByUserName.ORGDESC
    - contextPath: OMWS.GetEmpProfileByUserName.POSITIONDESC
  dockerimage: gable/python37:latest
  runonce: false
  script: |-
    from requests_ntlm import HttpNtlmAuth

    ''' IMPORTS '''

    import json
    import requests
    import uuid

    # Disable insecure warnings
    requests.packages.urllib3.disable_warnings()

    ''' CONSTANTS '''
    DATE_FORMAT = '%Y-%m-%dT%H:%M:%SZ'
    OUTPUT_PREFIX = "OMWS."
    # Dict contains method, add more method here in the future
    METHOD_NAME_MAP = {
        "GetUserProfile": "OM_WS_GetEmpProfileByUserName",
        "GetEmployeeDetail": "OM_WS_GetEmployeeFromVwEmployeeDetail"
    }

    class OMWSMethods:
        GetUserProfile = "OM_WS_GetEmpProfileByUserName"


    class Client(BaseClient):
        """
        OMWS API Client

        :param username: NTLM Username
        :param password: NTLM Password
        :param domain: NTLM Domain
        :param generate_uuids: Whether to autogenerate a transaction UUID
        :param OMcode: Server specific OM code.
        """
        USERNAME: str
        PASSWORD: str
        GENERATE_UUIDs: bool

        def __init__(
                self,
                username="",
                password="",
                domain="",
                generate_uuids=False,
                om_code="OMCODE",
                *args, **kwargs
        ):
            super(Client, self).__init__(*args, **kwargs)
            self.USERNAME = username
            self.PASSWORD = password
            self.GENERATE_UUIDs = generate_uuids
            # Setup NTLM Authentication for requests
            self._auth = HttpNtlmAuth(f'{domain}\\{username}', password)
            self.om_code = om_code

        def add_uuid_to_request(self, request_data):
            if self.GENERATE_UUIDs:
                request_data["transactionID"] = str(uuid.uuid1())
                return request_data

            return request_data

        def query_profile_data(self, om_code: str, parameter: dict, method_name: str = "GetUserProfile"):
            """
            Gets the profile data for a single user
            """
            # Allow the user to override the method name in the command
            #method_name = next(mn for mn in [method_name, OMWSMethods.GetUserProfile] if mn)
            method = METHOD_NAME_MAP.get(method_name)
            request_data = {
                "methodName": method,
                "omCode": om_code, # om_code as arg input
                "parameterList": [
                    parameter
                ],
            }
            request_data = self.add_uuid_to_request(request_data)
            data = self._http_request(
                method='POST',
                url_suffix="queryProfileData",
                json_data=request_data
            )
            return data


    class CommandRegister:
        commands: dict = {}

        def command(self, command_name: str):
            """
            Register a Command for this Integration

            :param command_name: The XSOAR integration command
            """

            def _decorator(func):
                self.commands[command_name] = func

                def _wrapper(client, demisto_args=None):
                    return func(client, demisto_args)

                return _wrapper

            return _decorator

        def run_command(self, command_name: str, client: Client, demisto_args: dict):
            if command_name not in self.commands:
                raise DemistoException("Command not found.")

            func = self.commands.get(command_name)
            command_result = func(client, demisto_args)
            return_results(command_result)


    # This is the store of all the commands available to this integration
    COMMANDS = CommandRegister()


    @COMMANDS.command("test-module")
    def test_module(client, demisto_args: dict):
        """
        Test the OMWS Client connection by attempting to query a common username
        """
        d = client.query_profile_data("maneenus","OMCODE")
        if d:
            return 'ok'
        else:
            raise DemistoException("Incorrect or empty API response")


    @COMMANDS.command("query-profile-data")
    def query_profile_data(client, demisto_args: dict):
        """Get a single profile"""
        query_username = demisto_args.get("username")
        #method_name = demisto_args.get("method_name", None)
        method_name = "GetUserProfile"
        om_code = demisto_args.get("om_code")
        parameter = {
                        "name": "Username",
                        "value": query_username
                    }

        d = client.query_profile_data(om_code, parameter, method_name)
        if d.get("responseDataList"):
            response_data_list = json.loads(d.get("responseDataList"))
            return CommandResults(
                readable_output=tableToMarkdown("OMWS Queried Profile", response_data_list),
                outputs_prefix=OUTPUT_PREFIX + "GetEmpProfileByUserName",
                outputs=response_data_list
            )
        else:
            error_message = "No user found"
            return error_message


    @COMMANDS.command("query-profile-detail")
    def query_profile_detail(client, demisto_args: dict):
        """Get detail information of an user"""
        query_employee_id = demisto_args.get("employee_id")
        #method_name = demisto_args.get("method_name", None)
        method_name = "GetEmployeeDetail"
        om_code = demisto_args.get("om_code")
        parameter = {
                        "name": "Pin",
                        "value": query_employee_id
                    }

        d = client.query_profile_data(om_code, parameter, method_name)
        if d.get("responseDataList"):
            response_data_list = json.loads(d.get("responseDataList"))
            return CommandResults(
                readable_output=tableToMarkdown("OMWS Queried Profile Detail", response_data_list),
                outputs_prefix=OUTPUT_PREFIX + "GetEmpProfileByUserName.Detail",
                outputs=response_data_list
            )
        else:
            error_message = "No user found"
            return error_message


    def main():
        """
            PARSE AND VALIDATE INTEGRATION PARAMS
        """
        username = demisto.params().get('credentials').get('identifier')
        password = demisto.params().get('credentials').get('password')
        ntlm_domain = demisto.params().get('domain')
        generate_uuids = demisto.params().get('generate_transaction_uuids', False)
        om_code = demisto.params().get('om_code', "OMCODE")
        # get the service API url - joins with the OMWS service endpoint
        base_url = demisto.params().get('url')
        base_url = urljoin(base_url, "/omworkdayws/api/WS_OM_OMService.svc")
        verify_certificate = not demisto.params().get('insecure', False)

        proxy = demisto.params().get('proxy', False)

        LOG(f'Command being called is {demisto.command()}')
        try:
            client = Client(
                base_url=base_url,
                verify=verify_certificate,
                proxy=proxy,
                username=username,
                password=password,
                domain=ntlm_domain,
                generate_uuids=generate_uuids,
                om_code=om_code
            )

            COMMANDS.run_command(demisto.command(), client, demisto.args())

        # Log exceptions
        except Exception as e:
            return_error(f'Failed to execute {demisto.command()} command. Error: {str(e)}')


    if __name__ in ('__main__', '__builtin__', 'builtins'):
        main()
  subtype: python3
  type: python
